trigger:
- main

variables:
  # Image info
  imageName: order
  tag: $(Build.BuildId)

pool:
  vmImage: ubuntu-latest

stages:
  - stage: Build
    displayName: Build and publish stage
    jobs:
      - job: DockerInstall
        displayName: Docker Install
        steps:
          - script: |
              echo "Listing source directory:"
              ls -R "$(System.DefaultWorkingDirectory)"
              echo "Listing build directory:"
              ls -R "$(Agent.BuildDirectory)"
            displayName: 'List Directories'

          - task: DockerInstaller@0
            inputs:
              dockerVersion: '17.09.0-ce'

      - template: appTemplates/build.yml
        parameters:
          acrServiceConnection: 'acr-svc-connection'
          imageName: 'order'
          dockerFilePath: '$(Build.sourcesdirectory)/app/order-service/Dockerfile'
          tag: $(tag)

      - template: appTemplates/build.yml
        parameters:
          acrServiceConnection: 'acr-svc-connection'
          imageName: 'product'
          dockerFilePath: '$(Build.sourcesdirectory)/app/product-service/Dockerfile'
          tag: $(tag)

      - template: appTemplates/build.yml
        parameters:
          acrServiceConnection: 'acr-svc-connection'
          imageName: 'store-front'
          dockerFilePath: '$(Build.sourcesdirectory)/app/store-front/Dockerfile'
          tag: $(tag)