trigger: none

variables:
  serviceConnection: 'arm-svc-con'
  aksCluster: 'aks-onlinestore-dev-uksouth-001'
  aksResourceGroup: 'rg-onlinestore-dev-uksouth-001'
  namespace: 'default' # or custom namespace
  manifestsPath: 'manifests/' # folder where your YAML files are
  imageName: order
  #tag: $(Build.BuildId)
  tag: latest

pool:
  vmImage: ubuntu-latest

stages:
  - stage: Build
    displayName: Build and publish stage
    jobs:
      - job: BuildPublishDockerImages
        displayName: Build Publish Docker Images
        steps:
          # - script: |
          #     echo "Listing source directory:"
          #     ls -R "$(System.DefaultWorkingDirectory)"
          #     echo "Listing build directory:"
          #     ls -R "$(Agent.BuildDirectory)"
          #   displayName: 'List Directories'

          - task: DockerInstaller@0
            displayName: Install Docker
            inputs:
              dockerVersion: '17.09.0-ce'

          - template: appTemplates/build.yml
            parameters:
              acrServiceConnection: 'acr-svc-connection'
              imageName: $(imageName)
              dockerFilePath: '$(Build.sourcesdirectory)/app/order-service/Dockerfile'
              tag: $(tag)

  - stage: Deploy
    displayName: Deploy Order Service in AKS
    jobs:     
      - job: DeplyUsingManifest
        steps:       
          - task: KubernetesManifest@1
            displayName: Deploy Order Service
            inputs:
              action: 'deploy'
              connectionType: 'azureResourceManager'
              azureSubscriptionConnection: $(serviceConnection)
              azureResourceGroup: $(aksResourceGroup)
              kubernetesCluster: $(aksCluster)
              manifests: |
                order-deployment.yml
                order-service.yml